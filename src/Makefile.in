# Changes should be made in Makefile.in instead of Makefile,
# or else they will be overwritten by configure.

#DEBUG =		-g
OPT =		-O3 -funroll-loops

LARGEFILE =	-D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64

# GIRS server (afd) is experimental and not compiled by default.
#GIRS =		/usr/local/girtools/girs

#FLAGS =		-Wall -Wno-unused-variable -Wno-unused-function \
#		${DEBUG} ${OPT} ${LARGEFILE} -I${GIRS}/src
FLAGS =		${DEBUG} ${OPT} ${LARGEFILE} -I${GIRS}/src
#CFLAGS =	-std=c89 -pedantic ${FLAGS}
CFLAGS =	${FLAGS}
CXXFLAGS =	-ansi -pedantic ${FLAGS} @CPPFLAGS@
# Not sure if we still use @CPPFLAGS@?

CC =		@CC@
CXX =		@CXX@

LIBS =		@LDFLAGS@ @LIBS@ -L. -laf -lm
LIBGSOAP =	@LIBGSOAP@
GSOAPCL =	soapC.o soapClient.o
GSOAPCLIENT =	@GSOAPCLIENT@
prefix =	@prefix@
exec_prefix =	@exec_prefix@
PREFIXBIN =	${DESTDIR}@bindir@

LIBAF =		libaf.a
LIBOBJ =	log.o open.o util.o lock.o search.o fdef.o index.o \
		docbuf.o admin.o explain.o stem.o \
		text.o xml.o xml_test.o erc.o \
		err.o info.o linear.o linbuf.o
BINOBJ =	afmain.o af.o
GSOAPO =	soapC.o soapClient.o soapClientLib.o soapServer.o soapServerLib.o \
		afdmain.o afd.o
GSOAPOBJ =	@GSOAPOBJ@

# Be careful about changing BIN; see the uninstall target below first.
BIN =		af @BIN@

SHELL =		/bin/sh

all: ${BIN}

%.d: %.cc
	@set -e; rm -f $@; \
		${CXX} -MM ${CXXFLAGS} $< > $@.$$$$; \
		sed 's,\($*\)\.o[ :]*,\1.o $@ : ,g' < $@.$$$$ > $@; \
		rm -f $@.$$$$

%.d: %.c
	@set -e; rm -f $@; \
		${CC} -MM ${CFLAGS} $< > $@.$$$$; \
		sed 's,\($*\)\.o[ :]*,\1.o $@ : ,g' < $@.$$$$ > $@; \
		rm -f $@.$$$$

-include $(LIBOBJ:.o=.d)
-include $(BINOBJ:.o=.d)
-include $(GSOAPOBJ:.o=.d)

af: ${LIBAF} afmain.o af.o ${GSOAPCLIENT}
	${CXX} -o af afmain.o af.o ${GSOAPCLIENT} ${LIBS} ${LIBGSOAP}

afd: ${LIBAF} afdmain.o afd.o soapC.o soapServer.o
	${CXX} -o afd afdmain.o afd.o soapC.o soapServer.o ${LIBS} ${LIBGSOAP}

${LIBAF}: ${LIBOBJ}
	ar rs ${LIBAF} ${LIBOBJ}

strip:
	strip af

install: all
	make strip
	mkdir -p ${PREFIXBIN}
	cp ${BIN} ${PREFIXBIN}/.

uninstall:
	if [ -d ${PREFIXBIN} ] ; then \
		cd ${PREFIXBIN} ; \
		rm -f ${BIN} ; \
	fi

clean:
	rm -f ${BIN} \
		afmain.o af.o afdmain.o afd.o soapC.o soapServer.o \
		${BINOBJ} ${LIBOBJ} ${LIBAF}

distclean:
	${MAKE} clean
	rm -f *.d
	rm -f *~ *#
