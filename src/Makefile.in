SHELL = /bin/sh
CC = g++
#DEBUG = -g
OPT = -O3 -funroll-loops
LARGEFILE = -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64
CXXFLAGS = @CPPFLAGS@ -Wall ${DEBUG} ${OPT} ${INCLUDE} ${LARGEFILE}
CLEAN = *.o core *.core
DISTCLEAN = *~
RM = rm -f
BINDIR = ../bin
LIBDIR = ../lib

# The GIRS server (amberfishd) is experimental and not compiled by
# default.
GIRS = /home/nassar/cvs/girtools/girs

INCLUDE = -Iinclude -Iengine -Idclass -I${GIRS}/src

LIBS = @LDFLAGS@ @LIBS@

all: include/version.h ${BINDIR}/afindex ${BINDIR}/afsearch ${BINDIR}/afadmin ${BINDIR}/affetch

amberfishd: include/version.h ${BINDIR}/amberfishd

${BINDIR}/amberfishd: ${LIBDIR}/libamberfish.a tools/amberfishd.o
	${CC} -o ${BINDIR}/amberfishd tools/amberfishd.o -L${LIBDIR} -lamberfish -lm ${LIBS} \
		-L${GIRS}/src -lgirs

${BINDIR}/afindex: ${LIBDIR}/libamberfish.a tools/afindex.o
	${CC} -o ${BINDIR}/afindex tools/afindex.o -L${LIBDIR} -lamberfish -lm ${LIBS}

${BINDIR}/afsearch: ${LIBDIR}/libamberfish.a tools/afsearch.o
	${CC} -o ${BINDIR}/afsearch tools/afsearch.o -L${LIBDIR} -lamberfish -lm ${LIBS}

${BINDIR}/afadmin: ${LIBDIR}/libamberfish.a tools/afadmin.o
	${CC} -o ${BINDIR}/afadmin tools/afadmin.o -L${LIBDIR} -lamberfish -lm ${LIBS}

${BINDIR}/affetch: tools/affetch.o
	${CC} -o ${BINDIR}/affetch tools/affetch.o

SRC = include/af.h \
		include/af_auto.h \
		engine/engine.h \
		engine/engine.cc \
		dclass/text.h \
		dclass/text.cc \
		dclass/xml.h \
		dclass/xml.cc \
		dclass/xml_test.h \
		dclass/xml_test.cc \
		dclass/syr1.h \
		dclass/syr1.cc \
		engine/docbuf.cc \
		engine/fdef.cc \
		engine/index.cc \
		engine/lock.cc \
		engine/search.cc \
		engine/util.cc \
		engine/admin.cc \
		engine/open.cc \
		engine/log.cc \
		engine/defs.h

OBJ = engine/engine.o \
		dclass/text.o \
		dclass/xml.o \
		dclass/xml_test.o \
		dclass/syr1.o

${LIBDIR}/libamberfish.a: ${OBJ}
	ar rs ${LIBDIR}/libamberfish.a ${OBJ}

engine/engine.o: ${SRC}

dclass/text.o: ${SRC}

dclass/xml.o: ${SRC}

dclass/xml_test.o: ${SRC}

dclass/syr1.o: ${SRC}

include/version.h:
	echo "#define ETYMON_AF_VERSION \"`cat ../VERSION`\"" > include/version.h

clean:
	${RM} ${CLEAN}
	cd include ; ${RM} ${CLEAN}
	cd engine ; ${RM} ${CLEAN}
	cd dclass ; ${RM} ${CLEAN}
	cd tools ; ${RM} ${CLEAN}
	cd ${LIBDIR} ; ${RM} libamberfish.a ${XERCES_LIB}
	cd ${BINDIR} ; ${RM} afindex afsearch afadmin affetch amberfishd

distclean:
	make clean
	${RM} ${DISTCLEAN}
	cd include ; ${RM} ${DISTCLEAN}
	cd engine ; ${RM} ${DISTCLEAN}
	cd dclass ; ${RM} ${DISTCLEAN}
	cd tools ; ${RM} ${DISTCLEAN}
