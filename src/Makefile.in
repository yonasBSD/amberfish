# Changes should be made in Makefile.in instead of Makefile,
# or else they will be overwritten by configure.

#DEBUG =		-g
OPT =		-O3 -funroll-loops

# GIRS server (amberfishd) is experimental and not compiled by default.
GIRS =		/usr/local/girtools/girs

LARGEFILE =	-D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64
CXXFLAGS =	@CPPFLAGS@ -Wall -Wno-unused-variable -Wno-unused-function \
			${DEBUG} ${OPT} ${LARGEFILE} -I${GIRS}/src
SHELL =		/bin/sh
CXX =		g++

LIBS =		@LDFLAGS@ @LIBS@ -L. -lamberfish -lm
PREFIX =	@prefix@
PREFIXBIN =	${PREFIX}/bin

LIBAMBERFISH =	libamberfish.a
LIBOBJ =	log.o open.o util.o lock.o search.o fdef.o index.o \
		docbuf.o admin.o explain.o \
		text.o xml.o xml_test.o syr1.o
BINOBJ =	af.o afindex.o afsearch.o afadmin.o affetch.o

# Be careful about changing BIN; see the uninstall target below first.
BIN =		af afindex afsearch afadmin affetch

all: ${BIN}

%.d: %.cc
	@set -e; rm -f $@; \
		${CXX} -MM ${CXXFLAGS} $< > $@.$$$$; \
		sed 's,\($*\)\.o[ :]*,\1.o $@ : ,g' < $@.$$$$ > $@; \
		rm -f $@.$$$$

-include $(LIBOBJ:.o=.d)
-include $(BINOBJ:.o=.d)

afindex: ${LIBAMBERFISH} afindex.o
	${CXX} -o afindex afindex.o ${LIBS}

afsearch: ${LIBAMBERFISH} afsearch.o
	${CXX} -o afsearch afsearch.o ${LIBS}

afadmin: ${LIBAMBERFISH} afadmin.o
	${CXX} -o afadmin afadmin.o ${LIBS}

affetch: affetch.o
	${CXX} -o affetch affetch.o

af: ${LIBAMBERFISH} af.o
	${CXX} -o af af.o ${LIBS}

amberfishd: ${LIBAMBERFISH} amberfishd.o
	${CXX} -o amberfishd amberfishd.o ${LIBS} \
		-L${GIRS}/src -lgirs

${LIBAMBERFISH}: ${LIBOBJ}
	ar rs ${LIBAMBERFISH} ${LIBOBJ}

install:
	mkdir -p ${PREFIXBIN}
	cp ${BIN} ${PREFIXBIN}/.

uninstall:
	cd ${PREFIXBIN} ; rm -f ${BIN}

clean:
	rm -f ${BIN} amberfishd \
		af.o afindex.o afsearch.o afadmin.o affetch.o amberfishd.o \
		${BINOBJ} ${LIBOBJ} ${LIBAMBERFISH}

distclean:
	make clean
	rm -f *~ *#
