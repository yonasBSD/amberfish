# Changes should be made in Makefile.in instead of Makefile,
# or else they will be overwritten by configure.

#DEBUG =		-g
OPT =		-O3 -funroll-loops

LARGEFILE =	-D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64

# GIRS server (afd) is experimental and not compiled by default.
GIRS =		/usr/local/girtools/girs

FLAGS =		-Wall -Wno-unused-variable -Wno-unused-function \
		${DEBUG} ${OPT} ${LARGEFILE} -I${GIRS}/src
CFLAGS =	-std=c89 -pedantic ${FLAGS}
CXXFLAGS =	-ansi -pedantic ${FLAGS} @CPPFLAGS@
# Not sure if we still use @CPPFLAGS@?

CXX =		g++
CC =		gcc

LIBS =		@LDFLAGS@ @LIBS@ -L. -laf -lm
PREFIX =	@prefix@
PREFIXBIN =	${PREFIX}/bin

LIBAF =		libaf.a
LIBOBJ =	log.o open.o util.o lock.o search.o fdef.o index.o \
		docbuf.o admin.o explain.o stem.o \
		text.o xml.o xml_test.o syr1.o \
		err.o info.o linear.o linbuf.o
#		search_new.o
#		open_new.o
BINOBJ =	afmain.o af.o

# Be careful about changing BIN; see the uninstall target below first.
BIN =		af affetch

SHELL =		/bin/sh

all: ${BIN}

%.d: %.cc
	@set -e; rm -f $@; \
		${CXX} -MM ${CXXFLAGS} $< > $@.$$$$; \
		sed 's,\($*\)\.o[ :]*,\1.o $@ : ,g' < $@.$$$$ > $@; \
		rm -f $@.$$$$

%.d: %.c
	@set -e; rm -f $@; \
		${CC} -MM ${CFLAGS} $< > $@.$$$$; \
		sed 's,\($*\)\.o[ :]*,\1.o $@ : ,g' < $@.$$$$ > $@; \
		rm -f $@.$$$$

-include $(LIBOBJ:.o=.d)
-include $(BINOBJ:.o=.d)

afindex: ${LIBAF} afindex.o
	${CXX} -o afindex afindex.o ${LIBS}

afsearch: ${LIBAF} afsearch.o
	${CXX} -o afsearch afsearch.o ${LIBS}

afadmin: ${LIBAF} afadmin.o
	${CXX} -o afadmin afadmin.o ${LIBS}

affetch: affetch.o
	${CXX} -o affetch affetch.o

af: ${LIBAF} afmain.o af.o
	${CXX} -o af afmain.o af.o ${LIBS}

afd: ${LIBAF} ${GIRS}/src/libgirs.a afdmain.o afd.o
	${CXX} -o afd afdmain.o afd.o ${LIBS} -L${GIRS}/src -lgirs

${LIBAF}: ${LIBOBJ}
	ar rs ${LIBAF} ${LIBOBJ}

install:
	mkdir -p ${PREFIXBIN}
	cp ${BIN} ${PREFIXBIN}/.

#uninstall:
#	cd ${PREFIXBIN} ; rm -f ${BIN}

clean:
	rm -f ${BIN} afd \
		afmain.o af.o afdmain.o afd.o \
		afindex afsearch afadmin affetch \
		${BINOBJ} ${LIBOBJ} ${LIBAF}

distclean:
	make clean
	rm -f *~ *#
